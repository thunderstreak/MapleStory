# 修复组队掉线无法登录问题

## 问题分析

当玩家在组队状态下掉线后无法重新登录时，可能是由于以下原因：

1. **地图状态异常**：角色可能卡在某个特殊地图（如组队地图、活动地图等），该地图在某些情况下无法正常加载
2. **组队状态残留**：虽然代码会尝试清理组队状态，但可能仍有残留数据
3. **登录状态检查**：`World.isCharacterListConnected` 可能误判角色仍在线

## 解决方案

### 方案 1：修改地图信息（推荐）

通过修改数据库中的地图信息，将角色移动到安全地图，可以解决大部分登录问题。

#### 安全地图 ID

- **新手村**：`100000000` - 最常用的默认地图
- **射手村**：`100000000`
- **其他常用安全地图**：
  - `100000000` - 新手村
  - `100000001` - 新手村（另一个入口）
  - `200000000` - 魔法密林
  - `300000000` - 勇士部落

#### SQL 修复脚本

```sql
-- 1. 查询角色当前地图信息
SELECT id, name, map, spawnpoint, party, world
FROM characters
WHERE name = '角色名';

-- 2. 将角色移动到安全地图（新手村）
UPDATE characters
SET map = 100000000,
    spawnpoint = 0,
    party = -1  -- 清除组队状态
WHERE name = '角色名';

-- 3. 如果知道角色ID，也可以使用ID更新
UPDATE characters
SET map = 100000000,
    spawnpoint = 0,
    party = -1
WHERE id = 角色ID;

-- 4. 批量修复所有卡在地图 600020300 的角色（根据你的日志，这是常见的问题地图）
UPDATE characters
SET map = 100000000,
    spawnpoint = 0,
    party = -1
WHERE map = 600020300;

-- 5. 查询所有在问题地图的角色
SELECT id, name, map, spawnpoint, party, world, accountid
FROM characters
WHERE map = 600020300;
```

### 方案 2：清除登录状态

如果修改地图后仍然无法登录，可能需要清除登录状态：

```sql
-- 1. 查询账号登录状态
SELECT id, name, loggedin, SessionIP, lastlogin
FROM accounts
WHERE name = '账号名';

-- 2. 重置登录状态
UPDATE accounts
SET loggedin = 0,
    SessionIP = ''
WHERE name = '账号名';

-- 3. 如果知道账号ID
UPDATE accounts
SET loggedin = 0,
    SessionIP = ''
WHERE id = 账号ID;
```

### 方案 3：清除组队状态

如果角色仍有组队状态残留：

```sql
-- 1. 查询角色的组队信息
SELECT id, name, party
FROM characters
WHERE name = '角色名';

-- 2. 清除组队状态
UPDATE characters
SET party = -1
WHERE name = '角色名';

-- 3. 批量清除所有有组队状态但实际不在组队中的角色
-- （注意：这个操作需要谨慎，可能会影响正常组队的玩家）
UPDATE characters
SET party = -1
WHERE party > 0
  AND party NOT IN (SELECT id FROM parties WHERE id = characters.party);
```

## 代码逻辑说明

### 地图加载逻辑

在 `MapleCharacter.loadCharFromDB()` 方法中（第 637-645 行）：

```java
ret.map = mapFactory.getMap(ret.mapid);
if (ret.map == null) {
    ret.map = mapFactory.getMap(100000000);  // 如果地图加载失败，使用默认地图
}
MaplePortal portal = ret.map.getPortal(ret.initialSpawnPoint);
if (portal == null) {
    portal = ret.map.getPortal(0);  // 如果出生点不存在，使用portal 0
    ret.initialSpawnPoint = 0;
}
```

**关键点**：

- 如果数据库中的地图 ID 无效或无法加载，代码会自动使用地图 `100000000` 作为默认地图
- 如果出生点（spawnpoint）无效，会使用 portal 0
- 因此，修改地图到 `100000000` 并设置 `spawnpoint = 0` 是安全的

### 登录检查逻辑

在 `InterServerHandler.Loggedin()` 方法中：

- 会检查角色是否已在其他频道登录
- 会尝试清理无效的玩家状态
- 如果检测到角色仍在线，会阻止登录

## 操作步骤

### 步骤 1：查询角色信息

```sql
SELECT id, name, map, spawnpoint, party, world, accountid
FROM characters
WHERE name = '角色名';
```

### 步骤 2：修改地图信息

```sql
UPDATE characters
SET map = 100000000,      -- 移动到新手村
    spawnpoint = 0,        -- 使用默认出生点
    party = -1             -- 清除组队状态
WHERE name = '角色名';
```

### 步骤 3：清除登录状态（如果需要）

```sql
UPDATE accounts
SET loggedin = 0,
    SessionIP = ''
WHERE id = (SELECT accountid FROM characters WHERE name = '角色名');
```

### 步骤 4：重启服务器或等待状态更新

- 如果服务器正在运行，可能需要等待几秒钟让状态更新
- 或者重启服务器以确保状态完全清除

## 预防措施

### 1. 定期清理无效状态

可以创建一个定期任务，清理卡在问题地图的角色：

```sql
-- 清理所有在问题地图的角色
UPDATE characters
SET map = 100000000,
    spawnpoint = 0,
    party = -1
WHERE map IN (600020300, 其他问题地图ID);
```

### 2. 监控登录失败

查看 `logs/组队掉线.log` 文件，监控登录失败的情况：

```bash
tail -f logs/组队掉线.log
```

### 3. 代码改进建议

虽然代码已经有默认地图保护，但可以考虑：

- 在地图加载失败时记录日志
- 自动将问题地图的角色移动到安全地图
- 增强组队状态清理逻辑

## 注意事项

1. **备份数据**：在执行任何 UPDATE 操作前，建议先备份数据库
2. **测试环境**：如果可能，先在测试环境验证
3. **影响范围**：批量更新操作会影响多个角色，需要谨慎
4. **组队状态**：清除组队状态可能会影响正在组队的玩家，建议在非高峰期操作

## 相关文件

- `src/client/MapleCharacter.java` - 角色加载逻辑
- `src/handling/channel/handler/InterServerHandler.java` - 登录处理逻辑
- `src/handling/world/World.java` - 世界状态管理

## 常见问题地图 ID

根据日志分析，以下地图可能出现问题：

- `600020300` - 组队相关地图（从日志中看到）
- 其他组队专用地图
- 活动地图
- 特殊副本地图

如果发现某个地图经常出现问题，可以考虑：

1. 检查该地图的配置是否正确
2. 将该地图加入黑名单，自动将角色移动到安全地图
3. 修复地图加载逻辑
