-- ============================================
-- 修复组队掉线无法登录问题 - SQL脚本
-- ============================================

-- ============================================
-- 1. 查询角色信息（根据角色名）
-- ============================================
-- 使用前请将 '角色名' 替换为实际的角色名
SELECT 
    id, 
    name, 
    map, 
    spawnpoint, 
    party, 
    world, 
    accountid,
    level,
    job
FROM characters 
WHERE name = '角色名';

-- ============================================
-- 2. 查询角色信息（根据角色ID）
-- ============================================
-- 使用前请将 角色ID 替换为实际的角色ID
SELECT 
    id, 
    name, 
    map, 
    spawnpoint, 
    party, 
    world, 
    accountid,
    level,
    job
FROM characters 
WHERE id = 角色ID;

-- ============================================
-- 3. 修复单个角色（根据角色名）
-- ============================================
-- 将角色移动到安全地图（新手村），清除组队状态
-- 使用前请将 '角色名' 替换为实际的角色名
UPDATE characters 
SET 
    map = 100000000,      -- 移动到新手村（安全地图）
    spawnpoint = 0,       -- 使用默认出生点
    party = -1            -- 清除组队状态
WHERE name = '角色名';

-- ============================================
-- 4. 修复单个角色（根据角色ID）
-- ============================================
-- 使用前请将 角色ID 替换为实际的角色ID
UPDATE characters 
SET 
    map = 100000000,      -- 移动到新手村（安全地图）
    spawnpoint = 0,       -- 使用默认出生点
    party = -1            -- 清除组队状态
WHERE id = 角色ID;

-- ============================================
-- 5. 批量修复卡在问题地图的角色
-- ============================================
-- 修复所有卡在地图 600020300 的角色（根据日志，这是常见的问题地图）
UPDATE characters 
SET 
    map = 100000000,      -- 移动到新手村
    spawnpoint = 0,       -- 使用默认出生点
    party = -1            -- 清除组队状态
WHERE map = 600020300;

-- ============================================
-- 6. 查询所有在问题地图的角色
-- ============================================
SELECT 
    id, 
    name, 
    map, 
    spawnpoint, 
    party, 
    world, 
    accountid,
    level,
    job
FROM characters 
WHERE map = 600020300;

-- ============================================
-- 7. 清除账号登录状态（根据账号名）
-- ============================================
-- 如果修改地图后仍然无法登录，可能需要清除登录状态
-- 使用前请将 '账号名' 替换为实际的账号名
UPDATE accounts 
SET 
    loggedin = 0,         -- 重置登录状态
    SessionIP = ''        -- 清除会话IP
WHERE name = '账号名';

-- ============================================
-- 8. 清除账号登录状态（根据账号ID）
-- ============================================
-- 使用前请将 账号ID 替换为实际的账号ID
UPDATE accounts 
SET 
    loggedin = 0,         -- 重置登录状态
    SessionIP = ''        -- 清除会话IP
WHERE id = 账号ID;

-- ============================================
-- 9. 清除账号登录状态（根据角色名查找账号）
-- ============================================
-- 使用前请将 '角色名' 替换为实际的角色名
UPDATE accounts 
SET 
    loggedin = 0,         -- 重置登录状态
    SessionIP = ''        -- 清除会话IP
WHERE id = (
    SELECT accountid 
    FROM characters 
    WHERE name = '角色名'
);

-- ============================================
-- 10. 查询账号登录状态
-- ============================================
-- 使用前请将 '账号名' 替换为实际的账号名
SELECT 
    id, 
    name, 
    loggedin, 
    SessionIP, 
    lastlogin,
    banned,
    tempban
FROM accounts 
WHERE name = '账号名';

-- ============================================
-- 11. 完整修复流程（角色名 + 账号状态）
-- ============================================
-- 一次性修复角色地图和账号登录状态
-- 使用前请将 '角色名' 替换为实际的角色名
START TRANSACTION;

-- 修复角色地图
UPDATE characters 
SET 
    map = 100000000,
    spawnpoint = 0,
    party = -1
WHERE name = '角色名';

-- 清除账号登录状态
UPDATE accounts 
SET 
    loggedin = 0,
    SessionIP = ''
WHERE id = (
    SELECT accountid 
    FROM characters 
    WHERE name = '角色名'
);

COMMIT;

-- ============================================
-- 12. 查询所有有组队状态的角色
-- ============================================
SELECT 
    id, 
    name, 
    map, 
    party, 
    world
FROM characters 
WHERE party > 0;

-- ============================================
-- 13. 清除所有角色的组队状态（谨慎使用）
-- ============================================
-- 注意：这个操作会影响所有有组队状态的角色
-- 建议只在确认需要时使用
-- UPDATE characters 
-- SET party = -1
-- WHERE party > 0;

-- ============================================
-- 14. 查询特定账号下的所有角色
-- ============================================
-- 使用前请将 账号ID 替换为实际的账号ID
SELECT 
    id, 
    name, 
    map, 
    spawnpoint, 
    party, 
    world,
    level,
    job
FROM characters 
WHERE accountid = 账号ID
ORDER BY level DESC;

-- ============================================
-- 15. 批量修复特定账号下的所有角色
-- ============================================
-- 使用前请将 账号ID 替换为实际的账号ID
UPDATE characters 
SET 
    map = 100000000,
    spawnpoint = 0,
    party = -1
WHERE accountid = 账号ID;

-- ============================================
-- 安全地图ID参考
-- ============================================
-- 100000000 - 新手村（最常用）
-- 100000001 - 新手村（另一个入口）
-- 200000000 - 魔法密林
-- 300000000 - 勇士部落
-- 
-- 建议使用 100000000 作为默认安全地图

-- ============================================
-- 使用说明
-- ============================================
-- 1. 先执行查询语句，确认角色当前状态
-- 2. 根据查询结果，选择合适的修复语句
-- 3. 执行修复语句后，等待几秒钟或重启服务器
-- 4. 让玩家重新尝试登录
-- 5. 如果仍然无法登录，检查账号登录状态并清除

