# 玩家登录状态数据库字段说明

## 数据库表：`accounts`

### 关键字段

#### 1. `loggedin` (TINYINT/BYTE)
**作用**：存储账号的登录状态

**状态值**：
- `0` = `LOGIN_NOTLOGGEDIN` - 未登录
- `1` = `LOGIN_SERVER_TRANSITION` - 服务器转换中（从登录服务器切换到频道服务器）
- `2` = `LOGIN_LOGGEDIN` - 已登录（正常游戏状态）
- `3` = `LOGIN_WAITING` - 等待中
- `6` = `CHANGE_CHANNEL` - 切换频道中

**更新位置**：
- `MapleClient.updateLoginState()` - 更新登录状态
- `MapleClient.getLoginState()` - 读取登录状态

#### 2. `SessionIP` (VARCHAR)
**作用**：存储当前会话的IP地址

**更新时机**：
- 登录时更新
- 切换频道时更新
- 断开连接时可能清空

#### 3. `lastlogin` (TIMESTAMP/DATETIME)
**作用**：记录最后登录时间

**用途**：
- 用于判断登录状态是否过期
- 如果状态是 `LOGIN_SERVER_TRANSITION` 或 `CHANGE_CHANNEL`，且超过20秒未更新，会自动重置为 `LOGIN_NOTLOGGEDIN`

## 登录状态判断逻辑

### 代码位置
- `src/client/MapleClient.java` - `getLoginState()` 方法
- `src/client/MapleClient.java` - `updateLoginState()` 方法
- `src/handling/channel/handler/InterServerHandler.java` - `Loggedin()` 方法

### 自动清理机制

```java
// 如果状态是服务器转换或切换频道，且超过20秒未更新，自动重置为未登录
if ((state == MapleClient.LOGIN_SERVER_TRANSITION || state == MapleClient.CHANGE_CHANNEL)
        && rs.getTimestamp("lastlogin").getTime() + 20000L < System.currentTimeMillis()) {
    state = MapleClient.LOGIN_NOTLOGGEDIN;
    this.updateLoginState(state, this.getSessionIPAddress());
}
```

## 登录流程中的状态变化

1. **初始状态**：`LOGIN_NOTLOGGEDIN (0)`
2. **登录验证通过**：`LOGIN_SERVER_TRANSITION (1)` 或 `LOGIN_WAITING (3)`
3. **进入频道服务器**：`CHANGE_CHANNEL (6)`
4. **成功登录游戏**：`LOGIN_LOGGEDIN (2)`
5. **断开连接**：`LOGIN_NOTLOGGEDIN (0)`

## 查询和修改登录状态

### 查询账号登录状态

```sql
-- 查询指定账号的登录状态
SELECT id, name, loggedin, SessionIP, lastlogin 
FROM accounts 
WHERE id = ?;

-- 查询所有在线玩家
SELECT id, name, loggedin, SessionIP, lastlogin 
FROM accounts 
WHERE loggedin = 2;

-- 查询所有卡在转换状态的玩家（超过20秒）
SELECT id, name, loggedin, SessionIP, lastlogin 
FROM accounts 
WHERE loggedin IN (1, 6) 
AND lastlogin < DATE_SUB(NOW(), INTERVAL 20 SECOND);
```

### 手动重置登录状态

```sql
-- 重置指定账号的登录状态为未登录
UPDATE accounts 
SET loggedin = 0 
WHERE id = ?;

-- 重置所有账号的登录状态（服务器启动时使用）
UPDATE accounts 
SET loggedin = 0;

-- 重置指定账号名的登录状态
UPDATE accounts 
SET loggedin = 0 
WHERE name = ?;
```

## 常见问题处理

### 问题1：玩家无法登录，提示"已有角色在线"

**可能原因**：
- `loggedin` 字段仍为 `2`（已登录），但实际玩家已断开连接
- 服务器异常关闭，状态未正确更新

**解决方法**：
```sql
-- 查询该账号的状态
SELECT id, name, loggedin, SessionIP, lastlogin 
FROM accounts 
WHERE name = '玩家名字';

-- 如果 loggedin = 2 但玩家实际不在线，重置状态
UPDATE accounts 
SET loggedin = 0 
WHERE name = '玩家名字' AND loggedin = 2;
```

### 问题2：玩家卡在"服务器转换中"状态

**可能原因**：
- 网络问题导致状态更新失败
- 服务器异常导致状态未正确更新

**解决方法**：
```sql
-- 查询卡在转换状态的玩家
SELECT id, name, loggedin, SessionIP, lastlogin 
FROM accounts 
WHERE loggedin IN (1, 6) 
AND lastlogin < DATE_SUB(NOW(), INTERVAL 20 SECOND);

-- 重置这些玩家的状态
UPDATE accounts 
SET loggedin = 0 
WHERE loggedin IN (1, 6) 
AND lastlogin < DATE_SUB(NOW(), INTERVAL 20 SECOND);
```

### 问题3：组队掉线后无法登录

**可能原因**：
- 玩家断开连接时，`loggedin` 状态未正确更新
- 玩家在 `PlayerStorage` 中仍存在，但客户端已断开

**解决方法**：
1. **检查数据库状态**：
```sql
SELECT id, name, loggedin, SessionIP, lastlogin 
FROM accounts 
WHERE name = '玩家名字';
```

2. **如果状态异常，重置**：
```sql
UPDATE accounts 
SET loggedin = 0 
WHERE name = '玩家名字';
```

3. **代码层面**（已在 `InterServerHandler.java` 和 `World.java` 中实现）：
   - 检查 `PlayerStorage` 中的玩家是否真正在线
   - 清理无效的客户端连接
   - 强制注销无效玩家

## 相关代码文件

1. **`src/client/MapleClient.java`**
   - `getLoginState()` - 获取登录状态
   - `updateLoginState()` - 更新登录状态
   - `disconnect()` - 断开连接时更新状态

2. **`src/handling/channel/handler/InterServerHandler.java`**
   - `Loggedin()` - 处理玩家登录逻辑
   - 检查登录状态并决定是否允许登录

3. **`src/handling/world/World.java`**
   - `isCharacterListConnected()` - 检查角色是否在线
   - 清理无效的玩家状态

4. **`src/server/Start.java`**
   - 服务器启动时重置所有账号的登录状态

## 注意事项

1. **不要频繁手动修改**：登录状态应该由服务器自动管理，手动修改可能导致数据不一致

2. **服务器启动时重置**：服务器启动时会自动将所有账号的 `loggedin` 重置为 `0`

3. **状态自动清理**：如果状态是 `LOGIN_SERVER_TRANSITION` 或 `CHANGE_CHANNEL`，且超过20秒未更新，系统会自动重置为 `LOGIN_NOTLOGGEDIN`

4. **状态检查时机**：登录时会检查 `loggedin` 字段，如果为 `LOGIN_LOGGEDIN (2)` 且角色确实在线，会阻止重复登录

