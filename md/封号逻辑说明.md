# 封号逻辑说明

## 概述

代码中确实存在封号逻辑，被封号的玩家**无法正常登录到游戏**。封号检查在登录流程中进行。

## 封号类型

### 1. 账号封号（Account Ban）

**数据库字段**：`accounts.banned`

**封号值**：
- `0` = 未封号（正常）
- `1` = 手动封号（GM手动封号）
- `2` = 系统自动封号（自动检测系统封号）
- `-1` = 自动解封（登录时自动解除）

**检查位置**：`src/client/MapleClient.java` - `login()` 方法

```java
final int banned = rs.getInt("banned");
if (banned > 0 && !this.gm) {
    loginok = 3;  // 返回登录失败，原因码3表示被封号
}
```

### 2. 临时封号（Temporary Ban）

**数据库字段**：`accounts.tempban` (TIMESTAMP)

**检查位置**：`src/handling/login/handler/CharLoginHandler.java`

```java
final Calendar tempbannedTill = c.getTempBanCalendar();
if (tempbannedTill.getTimeInMillis() != 0L) {
    // 发送临时封号消息
    c.getSession().write(LoginPacket.getTempBan(
        KoreanDateUtil.getTempBanTimestamp(tempbannedTill.getTimeInMillis()), 
        c.getBanReason()));
}
```

### 3. IP封号（IP Ban）

**数据库表**：`ipbans`

**检查位置**：`src/client/MapleClient.java` - `hasBannedIP()` 方法

```java
public boolean hasBannedIP() {
    // 查询 ipbans 表，检查IP是否被封
    final PreparedStatement ps = con
        .prepareStatement("SELECT COUNT(*) FROM ipbans WHERE ? LIKE CONCAT(ip, '%')");
    // ...
}
```

### 4. MAC封号（MAC Ban）

**数据库表**：`macbans`

**检查位置**：`src/client/MapleClient.java` - `isBannedMac()` 方法

```java
public boolean isBannedMac(final String mac) {
    // 查询 macbans 表，检查MAC地址是否被封
    final PreparedStatement ps = con
        .prepareStatement("SELECT COUNT(*) FROM macbans WHERE mac = ?");
    // ...
}
```

## 登录时的封号检查流程

### 检查顺序

1. **IP和MAC检查**（在 `CharLoginHandler.login()` 中）
   ```java
   final boolean ipBan = c.hasBannedIP();
   final boolean macBan = c.isBannedMac(macData);
   final boolean banned = ipBan || macBan || 防万能;
   ```

2. **账号封号检查**（在 `MapleClient.login()` 中）
   ```java
   final int banned = rs.getInt("banned");
   if (banned > 0 && !this.gm) {
       loginok = 3;  // 被封号
   }
   ```

3. **临时封号检查**（在 `CharLoginHandler.login()` 中）
   ```java
   final Calendar tempbannedTill = c.getTempBanCalendar();
   if (tempbannedTill.getTimeInMillis() != 0L) {
       // 发送临时封号消息
   }
   ```

### 登录失败原因码

根据 `LoginPacket.getLoginFailed()` 方法，不同的 `loginok` 值对应不同的错误：

- `loginok = 3` - **账号被封号**（`banned > 0`）
- `loginok = 4` - 密码错误或账号已登录
- `loginok = 7` - 账号已登录（需要解锁）

## 封号相关代码位置

### 1. 登录检查

**文件**：`src/client/MapleClient.java`
- `login()` 方法（第622行）- 检查账号封号状态
- `hasBannedIP()` 方法（第510行）- 检查IP封号
- `isBannedMac()` 方法（第471行）- 检查MAC封号
- `getTempBanCalendar()` 方法（第448行）- 获取临时封号时间

**文件**：`src/handling/login/handler/CharLoginHandler.java`
- `login()` 方法（第32行）- 登录处理，检查IP/MAC封号和临时封号

### 2. 封号操作

**文件**：`src/client/MapleCharacter.java`
- `ban()` 静态方法（第1117行）- GM手动封号
- `ban()` 实例方法（第4157行）- 玩家封号（自动封号）
- `tempban()` 方法（第4133行）- 临时封号

### 3. 解封操作

**文件**：`src/client/MapleClient.java`
- `unban()` 方法（第168行）- 解封账号
- `unlockAcc()` 方法（第655行）- 解锁账号（账号已登录状态）

## 数据库表结构

### accounts 表相关字段

```sql
banned INT          -- 封号状态：0=正常，1=手动封号，2=系统封号，-1=自动解封
banreason VARCHAR   -- 封号原因
tempban TIMESTAMP  -- 临时封号到期时间
greason TINYINT    -- 封号原因码
```

### ipbans 表

```sql
id INT PRIMARY KEY AUTO_INCREMENT
ip VARCHAR         -- 被封的IP地址（支持通配符匹配）
```

### macbans 表

```sql
id INT PRIMARY KEY AUTO_INCREMENT
mac VARCHAR        -- 被封的MAC地址
```

## 查询和修改封号状态

### 查询账号封号状态

```sql
-- 查询指定账号的封号状态
SELECT id, name, banned, banreason, tempban, greason 
FROM accounts 
WHERE name = '账号名';

-- 查询所有被封号的账号
SELECT id, name, banned, banreason, tempban 
FROM accounts 
WHERE banned > 0;

-- 查询系统自动封号的账号
SELECT id, name, banned, banreason 
FROM accounts 
WHERE banned = 2;
```

### 手动解封账号

```sql
-- 解封指定账号（手动封号）
UPDATE accounts 
SET banned = 0, banreason = '' 
WHERE id = ? AND banned = 1;

-- 解封指定账号（系统封号）
UPDATE accounts 
SET banned = 0, banreason = '' 
WHERE id = ? AND banned = 2;

-- 解封所有账号（谨慎使用）
UPDATE accounts 
SET banned = 0, banreason = '';

-- 解除临时封号
UPDATE accounts 
SET tempban = NULL, banreason = '', greason = 0 
WHERE id = ?;
```

### 手动封号

```sql
-- 手动封号（banned = 1）
UPDATE accounts 
SET banned = 1, banreason = '封号原因' 
WHERE id = ?;

-- 系统自动封号（banned = 2）
UPDATE accounts 
SET banned = 2, banreason = '系统检测到违规行为' 
WHERE id = ?;
```

### IP封号管理

```sql
-- 查询所有被封的IP
SELECT * FROM ipbans;

-- 添加IP封号
INSERT INTO ipbans (ip) VALUES ('192.168.1.100');

-- 删除IP封号
DELETE FROM ipbans WHERE ip = '192.168.1.100';
```

### MAC封号管理

```sql
-- 查询所有被封的MAC
SELECT * FROM macbans;

-- 添加MAC封号
INSERT INTO macbans (mac) VALUES ('00-11-22-33-44-55');

-- 删除MAC封号
DELETE FROM macbans WHERE mac = '00-11-22-33-44-55';
```

## 封号后的表现

### 1. 账号封号（banned = 1 或 2）

- **登录时**：返回 `loginok = 3`
- **客户端显示**：登录失败，无法进入游戏
- **GM可以登录**：GM账号（`gm > 0`）不受封号限制

### 2. 临时封号（tempban）

- **登录时**：发送临时封号消息，显示封号到期时间
- **客户端显示**：显示封号到期时间，无法登录直到到期

### 3. IP封号

- **登录时**：检查IP是否在 `ipbans` 表中
- **如果被封**：返回 `loginok = 3`，并自动封号账号

### 4. MAC封号

- **登录时**：检查MAC地址是否在 `macbans` 表中
- **如果被封**：返回 `loginok = 3`，并自动封号账号

## 自动解封机制

代码中存在自动解封机制：

```java
if (banned == -1) {
    this.unban();  // 自动解封
}
```

如果 `banned = -1`，登录时会自动调用 `unban()` 方法解封账号。

## 相关代码文件

1. **`src/client/MapleClient.java`**
   - `login()` - 登录检查，包括封号检查
   - `hasBannedIP()` - IP封号检查
   - `isBannedMac()` - MAC封号检查
   - `getTempBanCalendar()` - 临时封号检查
   - `unban()` - 解封账号

2. **`src/handling/login/handler/CharLoginHandler.java`**
   - `login()` - 登录处理，检查IP/MAC封号和临时封号

3. **`src/client/MapleCharacter.java`**
   - `ban()` - 封号操作
   - `tempban()` - 临时封号操作

4. **`src/tools/packet/LoginPacket.java`**
   - `getLoginFailed()` - 发送登录失败消息
   - `getPermBan()` - 发送永久封号消息
   - `getTempBan()` - 发送临时封号消息

## 注意事项

1. **GM账号不受封号限制**：代码中检查 `!this.gm`，GM账号可以绕过封号检查

2. **自动解封**：如果 `banned = -1`，登录时会自动解封

3. **IP和MAC封号会触发账号封号**：如果IP或MAC被封，登录时会自动封号账号

4. **临时封号优先级**：临时封号检查在账号封号检查之后，如果临时封号未到期，会显示临时封号消息

5. **封号原因**：封号原因存储在 `banreason` 字段中，可以通过查询数据库查看

## 排查无法登录的问题

如果玩家无法登录，可以按以下步骤排查：

1. **检查账号封号状态**：
   ```sql
   SELECT id, name, banned, banreason, tempban 
   FROM accounts 
   WHERE name = '账号名';
   ```

2. **检查IP封号**：
   ```sql
   SELECT * FROM ipbans 
   WHERE ip LIKE '%玩家IP%';
   ```

3. **检查MAC封号**：
   ```sql
   SELECT * FROM macbans 
   WHERE mac = '玩家MAC地址';
   ```

4. **检查登录状态**：
   ```sql
   SELECT id, name, loggedin, lastlogin 
   FROM accounts 
   WHERE name = '账号名';
   ```

5. **如果被封号，解封**：
   ```sql
   UPDATE accounts 
   SET banned = 0, banreason = '', tempban = NULL 
   WHERE name = '账号名';
   ```

