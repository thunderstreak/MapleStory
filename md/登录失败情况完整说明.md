# 登录失败情况完整说明

## 概述

本文档详细列出了游戏中所有可能导致登录失败的情况，包括账号验证、封号检查、服务器状态、角色状态等各个方面。

## 一、账号验证失败

### 1. 密码错误

**错误码**：`loginok = 4`

**检查位置**：`src/client/MapleClient.java:622-711`

**原因**：

- 密码不匹配（支持多种密码格式：Legacy、SHA1、Salted SHA512）
- 账号不存在

**代码逻辑**：

```java
if (LoginCryptoLegacy.isLegacyPassword(passhash) && LoginCryptoLegacy.checkPassword(pwd, passhash)) {
    loginok = 0;  // 成功
} else if (salt == null && LoginCrypto.checkSha1Hash(passhash, pwd)) {
    loginok = 0;  // 成功
} else if (LoginCrypto.checkSaltedSha512Hash(passhash, pwd, salt)) {
    loginok = 0;  // 成功
} else {
    loginok = 4;  // 密码错误
}
```

### 2. 登录尝试次数过多

**检查位置**：`src/handling/login/handler/CharLoginHandler.java:27-30`

**限制**：连续失败超过 5 次后不再返回错误消息

**代码逻辑**：

```java
private static boolean loginFailCount(final MapleClient c) {
    ++c.loginAttempt;
    return c.loginAttempt > 5;
}
```

## 二、封号相关

### 3. 账号被封号（Account Ban）

**错误码**：`loginok = 3`

**数据库字段**：`accounts.banned`

**封号值**：

- `0` = 未封号（正常）
- `1` = 手动封号（GM 手动封号）
- `2` = 系统自动封号（自动检测系统封号）
- `-1` = 自动解封（登录时自动解除）

**检查位置**：`src/client/MapleClient.java:644-645`

**代码逻辑**：

```java
if (banned > 0 && !this.gm) {
    loginok = 3;  // 被封号
}
```

**注意**：GM 账号不会被封号检查阻止

### 4. 临时封号（Temporary Ban）

**数据库字段**：`accounts.tempban` (TIMESTAMP)

**检查位置**：`src/handling/login/handler/CharLoginHandler.java:82-86`

**代码逻辑**：

```java
final Calendar tempbannedTill = c.getTempBanCalendar();
if (tempbannedTill.getTimeInMillis() != 0L) {
    c.getSession().write(LoginPacket.getTempBan(
        KoreanDateUtil.getTempBanTimestamp(tempbannedTill.getTimeInMillis()),
        c.getBanReason()));
}
```

**效果**：发送临时封号消息，阻止登录

### 5. IP 封号（IP Ban）

**数据库表**：`ipbans`

**检查位置**：`src/client/MapleClient.java:hasBannedIP()`

**代码逻辑**：

```java
final boolean ipBan = c.hasBannedIP();
if (ipBan && !c.isGm()) {
    loginok = 3;  // 被封号
}
```

**SQL 查询**：

```sql
SELECT COUNT(*) FROM ipbans WHERE ? LIKE CONCAT(ip, '%')
```

### 6. MAC 封号（MAC Ban）

**数据库表**：`macbans`

**检查位置**：`src/client/MapleClient.java:isBannedMac()`

**代码逻辑**：

```java
final boolean macBan = c.isBannedMac(macData);
if (macBan && !c.isGm()) {
    loginok = 3;  // 被封号
}
```

**SQL 查询**：

```sql
SELECT COUNT(*) FROM macbans WHERE mac = ?
```

## 三、登录器验证失败

### 7. 防万能登录器检查失败

**错误码**：`loginok = 1`

**检查位置**：`src/handling/login/handler/CharLoginHandler.java:52-76`

**代码逻辑**：

```java
boolean 防万能 = false;
if (!ip.equalsIgnoreCase("127.0.0.1") && getS == s) {
    防万能 = false;  // 当前代码中实际未启用
}
if (防万能) {
    c.getSession().write(MaplePacketCreator.serverNotice(1, "请使用本服专用登录器登录。"));
    c.getSession().write(LoginPacket.getLoginFailed(1));
    return;
}
```

**注意**：当前代码中此检查被禁用（始终为 false）

### 8. 密码为禁用密码

**错误码**：`loginok = 1`

**检查位置**：`src/handling/login/handler/CharLoginHandler.java:96-100`

**禁用密码**：

- `"disconnect"`
- `"fixme"`
- `"admin"`
- `"000000"`

**代码逻辑**：

```java
if (pwd.equalsIgnoreCase("disconnect") || pwd.equalsIgnoreCase("fixme")
    || pwd.equalsIgnoreCase("admin") || pwd.equalsIgnoreCase("000000")) {
    c.getSession().write(MaplePacketCreator.serverNotice(1, "你不可以使用这个作为密码."));
    c.getSession().write(LoginPacket.getLoginFailed(1));
    return;
}
```

## 四、账号状态检查

### 9. 账号已登录（登录状态异常）

**错误码**：`loginok = 7` 或 `loginok = 4`

**数据库字段**：`accounts.loggedin`

**状态值**：

- `0` = `LOGIN_NOTLOGGEDIN` - 未登录
- `1` = `LOGIN_SERVER_TRANSITION` - 服务器转换中
- `2` = `LOGIN_LOGGEDIN` - 已登录
- `3` = `LOGIN_WAITING` - 等待中
- `6` = `CHANGE_CHANNEL` - 切换频道中

**检查位置**：`src/client/MapleClient.java:650-658`

**代码逻辑**：

```java
final byte loginstate = this.getLoginState();
if (loginstate > MapleClient.LOGIN_NOTLOGGEDIN) {
    this.loggedIn = false;
    if (salt == null && LoginCrypto.checkSha1Hash(passhash, pwd)) {
        loginok = 7;  // 账号已登录，但密码正确，可以解锁
        this.unlockAcc();
    } else {
        loginok = 4;  // 账号已登录，密码错误
    }
}
```

**自动清理机制**：

- 如果状态是 `LOGIN_SERVER_TRANSITION` 或 `CHANGE_CHANNEL`，且超过 20 秒未更新，会自动重置为 `LOGIN_NOTLOGGEDIN`

### 10. 角色已在线

**检查位置**：`src/handling/channel/handler/InterServerHandler.java:220-323`

**检查逻辑**：

- 检查账号下所有角色是否已在其他频道在线
- 如果检测到角色在线，会尝试清理无效的在线状态
- 清理后再次检查，如果仍然在线，则阻止登录

**代码逻辑**：

```java
boolean allowLogin = !World.isCharacterListConnected(charNames);
if (!allowLogin) {
    c.setPlayer(null);
    c.getSession().close(true);
    return;
}
```

**日志记录**：`logs/组队掉线.log`

## 五、服务器状态检查

### 11. 服务器仅管理员模式

**错误码**：`loginok = 7`

**检查位置**：`src/handling/login/LoginWorker.java:14-17`

**代码逻辑**：

```java
if (LoginServer.isAdminOnly() && !c.isGm()) {
    c.getSession().write(MaplePacketCreator.serverNotice(1,
        "管管已设置仅管理员登录。\r\n我们目前正在修复几个问题，\r\n请耐心等待"));
    c.getSession().write(LoginPacket.getLoginFailed(7));
    return;
}
```

### 12. 服务器负载过高

**错误码**：`loginok = 7`

**检查位置**：`src/handling/login/LoginWorker.java:19-27`

**代码逻辑**：

```java
if (System.currentTimeMillis() - LoginWorker.lastUpdate > 600000L) {
    final List<Integer> load = ChannelServer.getChannelLoad();
    if (load == null || load.size() <= 0) {
        LoginWorker.lastUpdate = 0L;
        c.getSession().write(LoginPacket.getLoginFailed(7));
        return;
    }
    // 检查负载因子...
}
```

### 13. 频道服务器不存在

**检查位置**：`src/handling/login/handler/CharLoginHandler.java:305-307`

**代码逻辑**：

```java
if (ChannelServer.getInstance(c.getChannel()) == null || c.getWorld() != 0) {
    c.getSession().close(true);
    return;
}
```

## 六、角色创建相关

### 14. 职业未开放

**错误码**：`loginok = 1`

**检查位置**：`src/handling/login/handler/CharLoginHandler.java:174-187`

**配置项**：

- `RoyMS.qst` - 骑士团职业
- `RoyMS.mxj` - 冒险家职业
- `RoyMS.zs` - 战神职业

**代码逻辑**：

```java
if (!qst && JobType == 0) {
    c.getSession().write(MaplePacketCreator.serverNotice(1, "暂未开放骑士团职业！,请联系GM开放"));
    c.getSession().write(LoginPacket.getLoginFailed(1));
    return;
}
```

### 15. 角色名不符合要求

**检查位置**：`src/handling/login/handler/CharLoginHandler.java:290-296`

**检查项**：

- 角色名是否可用（`MapleCharacterUtil.canCreateChar(name)`）
- 角色名是否被禁止（`LoginInformationProvider.getInstance().isForbiddenName(name)`）

**代码逻辑**：

```java
if (MapleCharacterUtil.canCreateChar(name) && !LoginInformationProvider.getInstance().isForbiddenName(name)) {
    MapleCharacter.saveNewCharToDB(newchar, JobType, JobType == 1 && db == 0);
    c.getSession().write(LoginPacket.addNewCharEntry(newchar, true));
} else {
    c.getSession().write(LoginPacket.addNewCharEntry(newchar, false));
}
```

## 七、角色加载失败

### 16. 角色数据加载失败

**检查位置**：`src/handling/channel/handler/InterServerHandler.java:180-203`

**可能原因**：

- 数据库查询失败（SQLException）
- 角色数据损坏
- 数据库连接问题

**代码逻辑**：

```java
try {
    player = MapleCharacter.loadCharFromDB(charid, c, true);
} catch (Exception e) {
    System.err.println("加载角色数据失败: " + e.getMessage());
    e.printStackTrace();
    FileoutputUtil.outputFileError("logs/Packet_Except.log", e);
    // 登录流程中断
}
```

**日志记录**：`logs/Packet_Except.log`

### 17. 地图加载失败

**检查位置**：`src/handling/channel/handler/InterServerHandler.java:346-355`

**代码逻辑**：

```java
if (player.getMap() == null) {
    System.err.println("错误：玩家地图为 null - 角色: " + player.getName() + " 地图ID: " + player.getMapId());
    // 地图为 null，但不会阻止登录，只是无法添加到地图
}
```

**影响**：虽然不会直接导致登录失败，但可能导致玩家无法正常游戏

## 八、登录流程异常

### 18. 好友系统异常

**检查位置**：`src/handling/channel/handler/InterServerHandler.java:368-403`

**可能原因**：

- 好友列表为 null
- 好友数据损坏
- 数据库查询失败

**代码逻辑**：

```java
try {
    if (player.getBuddylist() != null) {
        buddyIds = player.getBuddylist().getBuddiesIds();
        World.Buddy.loggedOn(...);
    }
} catch (Exception e) {
    // 记录异常，但不阻止登录
    FileoutputUtil.outputFileError("logs/好友系统异常.log", e);
}
```

**日志记录**：`logs/好友系统异常.log`

**注意**：当前代码已添加异常处理，不会导致登录失败

### 19. 组队状态异常

**检查位置**：`src/handling/channel/handler/InterServerHandler.java:404-473`

**可能原因**：

- 组队中有无效成员
- 组队状态不一致
- 组队数据损坏

**处理逻辑**：

- 自动清理无效的组队成员
- 如果组队中只剩下当前玩家，自动清理组队状态
- 记录到 `logs/组队掉线.log`

**注意**：当前代码已添加清理逻辑，不会导致登录失败

### 20. 登录流程后续处理异常

**检查位置**：`src/handling/channel/handler/InterServerHandler.java:530-578`

**可能原因**：

- 封包发送失败
- 任务处理异常
- 其他初始化操作失败

**代码逻辑**：

```java
try {
    // 发送封包、处理任务等
} catch (Exception e) {
    System.err.println("登录流程后续处理异常 - 角色: " + player.getName() + " - " + e.getMessage());
    FileoutputUtil.outputFileError("logs/登录流程异常.log", e);
    // 记录异常，但不阻止登录
}
```

**日志记录**：`logs/登录流程异常.log`

**注意**：当前代码已添加异常处理，不会导致登录失败

## 九、数据库异常

### 21. 数据库连接失败

**检查位置**：多处数据库操作

**可能原因**：

- 数据库服务器不可用
- 数据库连接池耗尽
- 网络问题

**影响**：

- 账号验证失败
- 角色加载失败
- 登录状态检查失败

### 22. 数据库查询超时

**检查位置**：所有数据库操作

**可能原因**：

- 数据库负载过高
- 查询语句效率低
- 数据库锁等待

**影响**：

- 登录流程超时
- 客户端断开连接

## 十、网络异常

### 23. 客户端连接断开

**检查位置**：`src/handling/channel/handler/InterServerHandler.java:321-323`

**代码逻辑**：

```java
if (!allowLogin) {
    c.setPlayer(null);
    c.getSession().close(true);
    return;
}
```

**可能原因**：

- 网络不稳定
- 客户端超时
- 服务器主动断开

### 24. 封包发送失败

**检查位置**：登录流程中的封包发送操作

**可能原因**：

- 网络连接已断开
- 封包数据过大
- 缓冲区溢出

## 十一、其他异常

### 25. 角色认证失败

**检查位置**：`src/handling/login/handler/CharLoginHandler.java:301-303`

**代码逻辑**：

```java
if (!c.isLoggedIn() || loginFailCount(c) || !c.login_Auth(charId)) {
    c.getSession().write(MaplePacketCreator.enableActions());
    return;
}
```

**可能原因**：

- 登录状态不正确
- 登录尝试次数过多
- 角色认证失败

### 26. 角色列表加载失败

**检查位置**：`src/handling/login/handler/CharLoginHandler.java:152-157`

**代码逻辑**：

```java
final List<MapleCharacter> chars = c.loadCharacters(server);
if (chars != null) {
    c.getSession().write(LoginPacket.getCharList(...));
} else {
    c.getSession().close(true);
}
```

**可能原因**：

- 数据库查询失败
- 角色数据损坏
- 数据库连接问题

## 登录失败错误码总结

| 错误码 | 含义                                               | 检查位置                                   |
| ------ | -------------------------------------------------- | ------------------------------------------ |
| 0      | 登录成功                                           | -                                          |
| 1      | 一般错误（登录器验证失败、密码禁用、职业未开放等） | `CharLoginHandler.java`                    |
| 3      | 账号被封号                                         | `MapleClient.java:644`                     |
| 4      | 密码错误                                           | `MapleClient.java:675`                     |
| 5      | 初始值（未设置）                                   | `MapleClient.java:623`                     |
| 7      | 账号已登录、服务器仅管理员、服务器负载过高         | `MapleClient.java:654`, `LoginWorker.java` |

## 排查建议

### 1. 查看日志文件

- **`logs/ACPW.txt`** - 账号密码记录（成功登录）
- **`logs/Packet_Except.log`** - 封包异常
- **`logs/组队掉线.log`** - 组队相关登录问题
- **`logs/好友系统异常.log`** - 好友系统异常
- **`logs/登录流程异常.log`** - 登录流程后续处理异常
- **`logs/Login_Error.log`** - 登录错误（由 `FileoutputUtil.Login_Error` 定义）

### 2. 检查数据库状态

```sql
-- 检查账号封号状态
SELECT id, name, banned, tempban, loggedin, lastlogin
FROM accounts
WHERE name = ?;

-- 检查IP封号
SELECT * FROM ipbans WHERE ip LIKE ?;

-- 检查MAC封号
SELECT * FROM macbans WHERE mac = ?;

-- 检查角色在线状态
SELECT id, name, accountid, mapid
FROM characters
WHERE accountid = ?;
```

### 3. 检查服务器配置

- `RoyMS.AutoRegister` - 自动注册
- `RoyMS.qst` - 骑士团职业开放
- `RoyMS.mxj` - 冒险家职业开放
- `RoyMS.zs` - 战神职业开放

### 4. 检查服务器状态

- 服务器是否处于"仅管理员"模式
- 服务器负载是否过高
- 频道服务器是否正常运行
- 数据库连接是否正常

## 总结

登录失败可能由多种原因导致，包括：

1. ✅ **账号验证失败** - 密码错误、账号不存在
2. ✅ **封号检查** - 账号封号、临时封号、IP 封号、MAC 封号
3. ✅ **登录器验证** - 防万能登录器检查（当前未启用）
4. ✅ **账号状态** - 账号已登录、角色已在线
5. ✅ **服务器状态** - 仅管理员模式、负载过高、频道服务器不可用
6. ✅ **角色创建** - 职业未开放、角色名不符合要求
7. ✅ **角色加载** - 角色数据加载失败、地图加载失败
8. ✅ **登录流程异常** - 好友系统异常、组队状态异常、后续处理异常
9. ✅ **数据库异常** - 连接失败、查询超时
10. ✅ **网络异常** - 连接断开、封包发送失败

大部分异常情况已在代码中添加了异常处理和日志记录，不会直接导致登录失败，但可能会影响游戏体验。如果遇到登录问题，建议先查看相关日志文件以确定具体原因。
