# 装备品质与属性差异说明

## 概述

本文档解释了为什么游戏中金色名字的装备属性要比同样名字但是白色的装备高出很多。

## 装备品质系统

### 品质等级（State）

装备的品质由 `Equip.getState()` 方法决定，根据潜在能力（Potential）的值返回不同的品质等级：

```java
// src/client/inventory/Equip.java:509-524
public byte getState() {
    final int pots = this.potential1 + this.potential2 + this.potential3;
    if (this.potential1 >= 30000 || this.potential2 >= 30000 || this.potential3 >= 30000) {
        return 7;  // 金色/传说品质
    }
    if (this.potential1 >= 20000 || this.potential2 >= 20000 || this.potential3 >= 20000) {
        return 6;  // 紫色/史诗品质
    }
    if (pots >= 1) {
        return 5;  // 蓝色/稀有品质
    }
    if (pots < 0) {
        return 1;  // 诅咒装备
    }
    return 0;  // 白色/普通品质
}
```

### 品质等级对应

| 品质等级 | 颜色      | Potential 值范围   | 说明                 |
| -------- | --------- | ------------------ | -------------------- |
| State 7  | 金色/橙色 | potential >= 30000 | 传说品质，最高等级   |
| State 6  | 紫色      | potential >= 20000 | 史诗品质             |
| State 5  | 蓝色      | potential >= 1     | 稀有品质             |
| State 0  | 白色      | potential = 0      | 普通品质，无潜在能力 |
| State 1  | 红色      | potential < 0      | 诅咒装备             |

## 潜在能力（Potential）系统

### 潜在能力 ID 范围

潜在能力 ID 决定了可以获得的属性加成范围：

```java
// src/constants/GameConstants.java:1705-1723
public static boolean potentialIDFits(final int potentialID, final int newstate, final int i) {
    switch (newstate) {
        case 7: {  // 金色装备
            return (i == 0 || Randomizer.nextInt(10) == 0) ? (potentialID >= 30000)
                    : (potentialID >= 20000 && potentialID < 30000);
        }
        case 6: {  // 紫色装备
            return (i == 0 || Randomizer.nextInt(10) == 0) ? (potentialID >= 20000 && potentialID < 30000)
                    : (potentialID >= 10000 && potentialID < 20000);
        }
        case 5: {  // 蓝色装备
            return (i == 0 || Randomizer.nextInt(10) == 0) ? (potentialID >= 10000 && potentialID < 20000)
                    : (potentialID < 10000);
        }
        default: {
            return false;
        }
    }
}
```

### 潜在能力属性加成

潜在能力可以提供以下属性加成（定义在 `StructPotentialItem.java`）：

#### 基础属性加成

- `incSTR` - 力量
- `incDEX` - 敏捷
- `incINT` - 智力
- `incLUK` - 运气
- `incACC` - 命中率
- `incEVA` - 回避率
- `incSpeed` - 移动速度
- `incJump` - 跳跃力

#### 攻击防御属性

- `incPAD` - 物理攻击力
- `incMAD` - 魔法攻击力
- `incPDD` - 物理防御力
- `incMDD` - 魔法防御力

#### 百分比属性加成（更强大）

- `incSTRr` - 力量百分比
- `incDEXr` - 敏捷百分比
- `incINTr` - 智力百分比
- `incLUKr` - 运气百分比
- `incPADr` - 物理攻击力百分比
- `incMADr` - 魔法攻击力百分比
- `incPDDr` - 物理防御力百分比
- `incMDDr` - 魔法防御力百分比
- `incMHPr` - 最大 HP 百分比
- `incMMPr` - 最大 MP 百分比
- `incCr` - 暴击率百分比
- `incDAMr` - 总伤害百分比

#### 其他特殊属性

- `incMHP` / `incMMP` - 最大 HP/MP
- `ignoreTargetDEF` - 无视怪物防御百分比
- `ignoreDAMr` - 无视怪物伤害百分比
- `incAllskill` - 全技能等级
- `RecoveryUP` - 药水恢复量百分比

## 为什么金色装备属性更高？

### 1. 潜在能力 ID 范围更高

- **金色装备（State 7）**：潜在能力 ID >= 30000
  - 可以获得最高等级的属性加成
  - 属性值范围更大
- **白色装备（State 0）**：没有潜在能力（potential = 0）
  - 只有基础属性，没有额外加成
  - 无法获得百分比属性加成

### 2. 属性加成值差异

不同品质的装备，潜在能力提供的属性加成值范围不同：

- **金色装备**：潜在能力 ID >= 30000，可以提供：

  - 更高的基础属性值（如 +50 STR vs +10 STR）
  - 更高的百分比属性（如 +15% 攻击力 vs +3% 攻击力）
  - 更强大的特殊属性（如无视防御、总伤害加成等）

- **白色装备**：没有潜在能力，只有：
  - 装备的基础属性（从 WZ 文件读取的 `incXXX` 属性）
  - 无法获得额外的潜在能力加成

### 3. 属性计算方式

装备属性在 `PlayerStats.recalcLocalStats()` 方法中计算：

```java
// src/client/PlayerStats.java:355-376
for (final IItem item : chra.getInventory(MapleInventoryType.EQUIPPED)) {
    final IEquip equip = (IEquip) item;
    // 直接添加装备的基础属性
    this.accuracy += equip.getAcc();
    localmaxhp_ += equip.getHp();
    localmaxmp_ += equip.getMp();
    this.localdex += equip.getDex();
    this.localint_ += equip.getInt();
    this.localstr += equip.getStr();
    this.localluk += equip.getLuk();
    this.magic += equip.getMatk() + equip.getInt();
    this.watk += equip.getWatk();
    speed += equip.getSpeed();
    jump += equip.getJump();
    // ... 潜在能力的属性加成也会在这里应用
}
```

**金色装备** = 基础属性 + 潜在能力属性加成（高值）
**白色装备** = 基础属性（无潜在能力加成）

## 示例对比

假设有两件相同名字的装备：

### 白色装备（State 0）

- 基础攻击力：100
- 基础力量：20
- 潜在能力：无
- **总攻击力**：100
- **总力量**：20

### 金色装备（State 7）

- 基础攻击力：100
- 基础力量：20
- 潜在能力 1（potentialID >= 30000）：
  - `incPAD`：+50 物理攻击力
  - `incPADr`：+15% 物理攻击力
  - `incSTR`：+30 力量
  - `incSTRr`：+10% 力量
- 潜在能力 2：
  - `incDAMr`：+12% 总伤害
- **总攻击力**：100 + 50 + (100 + 50) \* 15% = 172.5
- **总力量**：20 + 30 + (20 + 30) \* 10% = 55

## 如何获得金色装备？

### 1. 使用潜在能力卷轴

使用潜在能力卷轴（Potential Scroll）可以为装备添加潜在能力：

```java
// src/client/inventory/Equip.java:526-531
public void resetPotential() {
    final int rank = (Randomizer.nextInt(100) < 4) ? ((Randomizer.nextInt(100) < 4) ? -7 : -6) : -5;
    this.setPotential1((short) rank);
    this.setPotential2((short) ((Randomizer.nextInt(10) == 1) ? rank : 0));
    this.setPotential3((short) 0);
}
```

### 2. 重新洗潜在能力

使用特定道具可以重新洗潜在能力，有机会获得更高品质：

```java
// src/client/inventory/Equip.java:533-539
public void renewPotential() {
    final int rank = (Randomizer.nextInt(100) < 4 && this.getState() != 7) ? (-(this.getState() + 1))
            : (-this.getState());
    this.setPotential1((short) rank);
    this.setPotential2((short) ((this.getPotential3() > 0) ? rank : 0));
    this.setPotential3((short) 0);
}
```

### 3. 概率说明

- 4% 概率获得更高一级的品质
- 金色装备（State 7）的概率非常低（约 0.16% = 4% \* 4%）

## 总结

金色装备属性更高的原因：

1. ✅ **潜在能力 ID 范围更高**：金色装备的潜在能力 ID >= 30000，可以获得最高等级的属性加成
2. ✅ **属性加成值更大**：金色装备的潜在能力可以提供更高的基础属性值和百分比属性
3. ✅ **额外属性加成**：金色装备可以有多个潜在能力（potential1, potential2, potential3），提供更多属性加成
4. ✅ **百分比属性**：金色装备可以获得百分比属性加成（如攻击力百分比），这些加成会随着基础属性增长而增长

**白色装备**只有基础属性，没有潜在能力加成，所以属性远低于金色装备。

## 相关代码文件

- `src/client/inventory/Equip.java` - 装备类和品质判断
- `src/server/StructPotentialItem.java` - 潜在能力属性定义
- `src/client/PlayerStats.java` - 属性计算
- `src/constants/GameConstants.java` - 潜在能力 ID 范围判断
- `src/server/MapleItemInformationProvider.java` - 装备属性读取
