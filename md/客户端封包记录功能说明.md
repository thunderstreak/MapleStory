# 客户端封包记录功能说明

## 功能概述

已添加根据角色名自动保存客户端发送的封包到日志文件的功能。每个角色的封包会保存到独立的日志文件中。

**注意**：此功能需要通过配置文件启用，默认是关闭的。

## 配置说明

### 配置文件

**文件**：`config/server.properties`

### 配置项

```properties
#记录玩家封包（根据角色名保存客户端发送的封包到 logs/客户端封包/角色名.log）
RoyMS.EnablePlayerPacketLog = false
```

### 配置值

- `true` - 启用功能，记录所有已登录玩家的客户端封包
- `false` - 关闭功能，不记录封包（默认值）

### 启用方法

1. 打开 `config/server.properties` 文件
2. 找到 `RoyMS.EnablePlayerPacketLog` 配置项
3. 将值改为 `true`
4. 重启服务器

## 实现位置

**文件**：`src/handling/MapleServerHandler.java`

**方法**：`messageReceived()` - 处理客户端发送的封包

**配置读取**：`src/constants/ServerConstants.java` - 从 `server.properties` 读取配置

## 功能说明

### 保存位置

封包日志保存在：`logs/客户端封包/角色名.log`

例如：

- 角色名：`西子尔` → 日志文件：`logs/客户端封包/西子尔.log`
- 角色名：`测试角色` → 日志文件：`logs/客户端封包/测试角色.log`

### 记录内容

每条封包记录包含以下详细信息，便于错误分析：

#### 1. 基础信息

- **时间戳**：封包接收时间（可读格式 + Unix 时间戳）
- **线程信息**：处理封包的线程名称和 ID

#### 2. 账号信息

- **账号名**：玩家账号名称
- **账号 ID**：账号唯一标识
- **登录状态**：是否已登录
- **世界**：所在世界编号
- **频道**：所在频道编号
- **IP 地址**：客户端 IP 地址
- **MAC 地址**：客户端 MAC 地址
- **延迟**：网络延迟（毫秒）

#### 3. 角色信息

- **角色名**：角色名称
- **角色 ID**：角色唯一标识
- **等级**：角色等级
- **职业**：角色职业 ID
- **地图 ID**：当前所在地图
- **经验值**：当前经验值
- **金币**：当前金币数量

#### 4. 封包信息

- **操作码**：封包类型（如 `MOVE_PLAYER`、`USE_ITEM` 等）
- **封包头**：十六进制格式（如 `0x0024`）
- **封包长度**：封包字节数
- **处理状态**：封包处理是否成功
- **处理耗时**：封包处理耗时（毫秒）
- **异常信息**：如果处理失败，记录异常类型、消息和堆栈

#### 5. 封包数据

- **十六进制数据**：完整封包数据的十六进制表示
- **ASCII 数据**：封包数据的 ASCII 表示

### 日志格式示例

```
========== 客户端封包记录 ==========
时间：2025-11-21 12:00:00 (时间戳: 1703127600000)
线程：NioProcessor-1 (ID: 15)
-----------------------------------
【账号信息】
  账号名：testuser
  账号ID：12345
  登录状态：已登录
  世界：0
  频道：1
  IP地址：192.168.1.100
  MAC地址：00-11-22-33-44-55
  延迟：25ms
-----------------------------------
【角色信息】
  角色名：西子尔
  角色ID：67890
  等级：150
  职业：412
  地图ID：100000000
  经验值：5000000
  金币：10000000
-----------------------------------
【封包信息】
  操作码：MOVE_PLAYER
  封包头：0x0024 (36)
  封包长度：25 字节
  处理状态：成功
  处理耗时：2ms
-----------------------------------
【封包数据】
  十六进制：24 00 01 02 03 04 05 06 07 08 09 0A 0B 0C 0D 0E 0F 10 11 12 13 14 15 16 17 18
  ASCII数据：$...........
===================================

========== 客户端封包记录 ==========
时间：2025-11-21 12:00:01 (时间戳: 1703127601000)
线程：NioProcessor-1 (ID: 15)
-----------------------------------
【账号信息】
  账号名：testuser
  账号ID：12345
  登录状态：已登录
  世界：0
  频道：1
  IP地址：192.168.1.100
  MAC地址：00-11-22-33-44-55
  延迟：30ms
-----------------------------------
【角色信息】
  角色名：西子尔
  角色ID：67890
  等级：150
  职业：412
  地图ID：100000000
  经验值：5000000
  金币：10000000
-----------------------------------
【封包信息】
  操作码：USE_ITEM
  封包头：0x0045 (69)
  封包长度：10 字节
  处理状态：失败
  处理耗时：5ms
  异常信息：java.lang.NullPointerException
  异常消息：Item not found
  异常堆栈：
    handling.channel.handler.InventoryHandler.handlePacket(InventoryHandler.java:123)
    handling.MapleServerHandler.messageReceived(MapleServerHandler.java:391)
-----------------------------------
【封包数据】
  十六进制：45 00 01 02 03 04 05 06 07 08 09
  ASCII数据：E.........
===================================
```

## 代码实现

### 关键代码

代码会捕获封包处理过程中的异常，并记录详细的上下文信息：

```java
// 根据角色名保存客户端封包（需要配置启用）
final long packetReceiveTime = System.currentTimeMillis();
boolean packetHandled = false;
Exception packetException = null;
if (ServerConstants.EnablePlayerPacketLog && c != null && c.getPlayer() != null
        && c.getPlayer().getName() != null) {
    try {
        handlePacket(recv, slea, c, this.cs);
        packetHandled = true;
    } catch (Exception e) {
        packetHandled = false;
        packetException = e;
    }
    // 记录详细的封包信息，包括账号、角色、封包数据和异常信息
    // ... 详细记录代码 ...
}
```

### 错误分析优势

增强的日志记录提供了以下优势：

1. **完整的上下文信息**：记录账号、角色、地图等状态，便于重现问题
2. **异常捕获**：如果封包处理失败，会记录完整的异常堆栈
3. **性能监控**：记录封包处理耗时，便于发现性能问题
4. **线程追踪**：记录处理线程信息，便于多线程问题分析
5. **网络信息**：记录 IP、MAC、延迟等信息，便于网络问题排查

### 触发条件

- ✅ **配置已启用**（`ServerConstants.EnablePlayerPacketLog = true`）
- ✅ 玩家已登录（`c.getPlayer() != null`）
- ✅ 角色名存在（`c.getPlayer().getName() != null`）
- ✅ 封包已成功解析（找到了对应的 `RecvPacketOpcode`）

### 不记录的情况

- ❌ **配置未启用**（`RoyMS.EnablePlayerPacketLog = false`）
- ❌ 玩家未登录（登录前不记录）
- ❌ 角色名为空
- ❌ 未定义的封包（会记录到 `logs/未定义封包.log`）

## 使用场景

### 1. 调试特定玩家的封包问题

如果某个玩家遇到问题，可以查看该玩家的封包日志：

```bash
cat logs/客户端封包/玩家名.log
```

### 2. 分析玩家行为

通过封包日志可以分析玩家的操作序列，例如：

- 移动路径
- 物品使用
- 技能释放
- NPC 交互

### 3. 检测异常封包

如果玩家发送了异常封包，可以在日志中看到完整的封包数据。

## 注意事项

### 1. 日志文件大小

- 每个角色的封包日志会持续追加
- 长时间游戏可能导致日志文件很大
- 建议定期清理或归档旧日志

### 2. 性能影响

- 每个封包都会写入文件，可能影响性能
- 如果服务器负载较高，可以考虑：
  - 只记录特定类型的封包
  - 添加开关控制是否记录
  - 使用异步写入

### 3. 磁盘空间

- 多个玩家同时在线会产生多个日志文件
- 需要确保 `logs/客户端封包/` 目录有足够的磁盘空间

### 4. 文件权限

- 确保服务器有权限在 `logs/客户端封包/` 目录下创建和写入文件
- 目录不存在时会自动创建

## 优化建议（可选）

### 方案 1：添加开关控制

可以在配置文件中添加开关，控制是否启用封包记录：

```java
// 在 ServerConstants 中添加
public static boolean EnablePlayerPacketLog = Boolean.parseBoolean(
    ServerProperties.getProperty("RoyMS.EnablePlayerPacketLog", "true"));

// 在代码中使用
if (ServerConstants.EnablePlayerPacketLog && c != null && ...) {
    // 记录封包
}
```

### 方案 2：只记录特定封包类型

可以添加白名单或黑名单，只记录特定类型的封包：

```java
// 只记录这些封包类型
final Set<RecvPacketOpcode> loggedPackets = EnumSet.of(
    RecvPacketOpcode.USE_ITEM,
    RecvPacketOpcode.MOVE_PLAYER,
    // ... 其他需要记录的封包
);

if (loggedPackets.contains(recv) && ...) {
    // 记录封包
}
```

### 方案 3：限制日志文件大小

可以添加日志文件大小限制，超过限制时轮转：

```java
// 在 FileoutputUtil.packetLog 中添加文件大小检查
if (outputFile.exists() && outputFile.length() > 10 * 1024 * 1024) { // 10MB
    // 轮转日志文件
    outputFile.renameTo(new File(file + ".old"));
}
```

## 相关文件

- `src/handling/MapleServerHandler.java` - 封包接收和处理
- `src/tools/FileoutputUtil.java` - 日志写入工具
- `src/tools/HexTool.java` - 十六进制转换工具
- `src/handling/RecvPacketOpcode.java` - 客户端封包操作码定义

## 日志文件位置

```
logs/
  └── 客户端封包/
      ├── 角色名1.log
      ├── 角色名2.log
      └── ...
```

## 查看日志

### 查看特定玩家的封包

```bash
# 查看最新封包
tail -f logs/客户端封包/角色名.log

# 查看所有封包
cat logs/客户端封包/角色名.log

# 搜索特定封包类型
grep "MOVE_PLAYER" logs/客户端封包/角色名.log
```

### 统计封包数量

```bash
# 统计某个玩家的封包数量
wc -l logs/客户端封包/角色名.log

# 统计特定封包类型的数量
grep -c "USE_ITEM" logs/客户端封包/角色名.log
```
